# Feature Specification: CFD 求解器 Web 介面

**Feature Branch**: `001-web-cfd-interface`
**Created**: 2025-11-02
**Status**: Draft
**Input**: User description: "建立 Web 介面讓使用者可以輸入流場邊界條件和參數(Reynolds number, 網格尺寸, 鬆弛因子等),使用現有的 SIMPLEC CFD 求解器分析流場。求解過程要在網頁上即時顯示進度(迭代次數、殘差值),求解完成後要在網頁上繪製壓力等高線圖、速度向量圖和中心線速度分佈圖。使用 FastAPI 後端、React 前端和 Plotly.js 視覺化。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基本流場模擬執行 (Priority: P1)

使用者開啟 Web 介面,輸入基本流場參數 (Reynolds number, 網格尺寸),啟動求解器,觀看即時求解進度,並在完成後查看壓力等高線圖、速度向量圖和中心線速度分佈圖。

**Why this priority**: 這是核心功能,提供端到端的流場模擬體驗。沒有此功能,整個系統沒有價值。這是最小可行產品 (MVP)。

**Independent Test**: 使用者可以完整地從參數輸入到結果視覺化,不依賴任何其他功能。測試方式:輸入 Reynolds number = 100, 網格尺寸 41x41,啟動求解,查看三種圖表。

**Acceptance Scenarios**:

1. **Given** 使用者開啟 Web 介面首頁, **When** 填寫 Reynolds number 和網格尺寸並點擊「開始求解」, **Then** 系統開始執行 SIMPLEC 求解器並顯示即時進度資訊
2. **Given** 求解器正在執行, **When** 求解過程進行中, **Then** 頁面即時更新顯示當前迭代次數和殘差值
3. **Given** 求解器完成計算, **When** 計算收斂或達到最大迭代次數, **Then** 系統自動繪製並顯示壓力等高線圖、速度向量圖和中心線速度分佈圖

---

### User Story 2 - 進階參數控制 (Priority: P2)

使用者可以調整進階求解器參數,包括鬆弛因子 (alpha_u, alpha_p)、最大迭代次數、收斂標準等,以優化求解過程或探索不同數值方案的影響。

**Why this priority**: 進階使用者需要調整數值參數來研究不同設定的影響。但基本使用者可以使用預設值,因此優先度低於 P1。

**Independent Test**: 在 P1 功能基礎上,使用者可以展開進階參數面板,修改鬆弛因子和收斂標準,執行求解並比較結果。測試方式:設定 alpha_u = 0.5 (而非預設 0.7),觀察收斂速度變化。

**Acceptance Scenarios**:

1. **Given** 使用者在參數輸入頁面, **When** 點擊「顯示進階參數」, **Then** 展開進階參數設定區域 (鬆弛因子、最大迭代次數、收斂標準)
2. **Given** 使用者修改進階參數, **When** 啟動求解, **Then** 系統使用自訂參數執行求解器
3. **Given** 使用者未設定進階參數, **When** 啟動求解, **Then** 系統使用合理的預設值 (alpha_u=0.7, alpha_p=1.0, max_iter=10000, tolerance=1e-5)

---

### User Story 3 - 結果匯出與儲存 (Priority: P3)

使用者可以將求解結果 (包含圖表和數值資料) 匯出為檔案,方便後續分析或報告撰寫。

**Why this priority**: 這是輔助功能,方便使用者保存和分享結果,但不影響核心的求解和視覺化功能。

**Independent Test**: 在 P1 求解完成後,使用者可以點擊匯出按鈕,下載圖表圖片和流場數據檔案。測試方式:完成一次求解,點擊「匯出結果」,確認下載了 PNG 圖片和 JSON/CSV 數據檔。

**Acceptance Scenarios**:

1. **Given** 求解已完成並顯示結果圖表, **When** 使用者點擊「匯出圖表」按鈕, **Then** 系統下載包含所有圖表的圖片檔案 (PNG 或 SVG)
2. **Given** 求解已完成, **When** 使用者點擊「匯出數據」按鈕, **Then** 系統下載包含流場數值資料的結構化檔案 (JSON 或 CSV)
3. **Given** 使用者需要重現結果, **When** 匯出時包含輸入參數, **Then** 檔案中記錄所有輸入參數供日後參考

---

### Edge Cases

- **網格尺寸過大**: 當使用者輸入網格尺寸超過合理範圍 (例如 >200x200) 時,系統應警告計算時間可能過長,並建議合理範圍
- **Reynolds number 極端值**: 當 Reynolds number 過高 (>10000) 或過低 (<1) 時,系統應警告求解可能不穩定或不收斂
- **求解中斷**: 使用者在求解過程中關閉瀏覽器或離線時,後端求解任務應能繼續執行,並允許使用者稍後查看結果
- **同時多個求解**: 當使用者啟動新的求解任務時,正在執行的舊任務應被妥善處理 (取消或排隊)
- **求解失敗**: 當求解器因數值不穩定或參數錯誤無法收斂時,系統應顯示清楚的錯誤訊息和建議
- **瀏覽器相容性**: 圖表視覺化應在主流瀏覽器 (Chrome, Firefox, Edge, Safari) 上正常運作
- **無效輸入**: 使用者輸入非數值、負數或零值時,系統應即時驗證並顯示錯誤提示

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須提供網頁表單讓使用者輸入基本流場參數 (Reynolds number, 網格尺寸 NX, NY)
- **FR-002**: 系統必須提供進階參數設定選項,包括鬆弛因子 (alpha_u, alpha_p)、最大迭代次數、收斂標準
- **FR-003**: 系統必須即時驗證使用者輸入,確保參數在合理範圍內 (例如 Reynolds number > 0, 網格尺寸 >= 10)
- **FR-004**: 系統必須在使用者提交參數後啟動現有的 SIMPLEC CFD 求解器
- **FR-005**: 系統必須在求解過程中透過網頁即時顯示進度資訊,包括當前迭代次數和 u、v 速度的殘差值
- **FR-006**: 系統必須在求解完成後繪製並顯示壓力等高線圖
- **FR-007**: 系統必須在求解完成後繪製並顯示速度向量圖
- **FR-008**: 系統必須在求解完成後繪製並顯示中心線速度分佈圖 (u 速度沿垂直中心線, v 速度沿水平中心線)
- **FR-009**: 系統必須在求解失敗或不收斂時向使用者顯示清楚的錯誤訊息
- **FR-010**: 系統必須允許使用者匯出視覺化圖表為圖片檔案
- **FR-011**: 系統必須允許使用者匯出流場數值資料為結構化檔案
- **FR-012**: 系統必須在輸出檔案中包含所有輸入參數,以便重現結果
- **FR-013**: 系統必須提供預設參數值,讓不熟悉數值方法的使用者也能快速開始模擬

### Key Entities

- **模擬任務 (Simulation Job)**: 代表一次完整的流場求解任務,包含輸入參數、執行狀態、進度資訊、結果資料。主要屬性:任務 ID、建立時間、狀態 (待執行/執行中/完成/失敗)、輸入參數 (Reynolds number, 網格尺寸, 鬆弛因子等)、當前迭代次數、殘差值。

- **輸入參數 (Simulation Parameters)**: 代表使用者輸入的所有求解器參數。主要屬性:Reynolds number, 網格尺寸 (NX, NY), 鬆弛因子 (alpha_u, alpha_p), 最大迭代次數, 收斂標準, 上蓋速度, 流體物性 (密度, 黏度)。

- **求解進度 (Solver Progress)**: 代表求解器即時執行狀態。主要屬性:當前迭代次數、u 速度殘差、v 速度殘差、預估剩餘時間、執行開始時間。

- **流場結果 (Flow Field Results)**: 代表求解完成後的流場資料。主要屬性:壓力場陣列、u 速度場陣列、v 速度場陣列、網格座標、收斂歷史、最終殘差值。

- **視覺化圖表 (Visualization Plots)**: 代表產生的圖表資料。主要屬性:圖表類型 (等高線/向量/分佈圖)、繪圖資料格式 (JSON for Plotly.js)、圖片檔案 (PNG/SVG)。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者從開啟網頁到啟動第一次求解,能在 1 分鐘內完成參數輸入
- **SC-002**: 求解進度資訊更新延遲不超過 2 秒,讓使用者能即時掌握求解狀態
- **SC-003**: 標準測試案例 (Re=100, 41x41 網格) 的求解和視覺化總時間不超過 30 秒
- **SC-004**: 三種視覺化圖表 (壓力等高線、速度向量、中心線分佈) 在求解完成後 5 秒內全部顯示
- **SC-005**: 使用者能成功匯出包含完整輸入參數和結果資料的檔案,供後續重現或分析
- **SC-006**: 系統能正確處理並提示至少 5 種常見輸入錯誤 (如負數、過大網格、無效字元等)
- **SC-007**: Web 介面在主流瀏覽器 (Chrome, Firefox, Edge) 上正常運作,視覺化圖表可互動縮放
- **SC-008**: 90% 的使用者能在第一次使用時成功完成至少一次流場模擬並查看結果

## Assumptions *(if applicable)*

- 假設使用者具備基本的流體力學知識,理解 Reynolds number 和邊界條件的意義
- 假設求解器在單一伺服器上執行,不需要分散式運算或任務佇列
- 假設使用者每次只執行一個求解任務,不需要同時處理多個模擬
- 假設現有的 `simplec.py` 程式碼可以被重構為可呼叫的函式或類別,而不需完全重寫
- 假設求解過程產生的資料量在合理範圍內 (< 10 MB),可以透過 WebSocket 即時傳輸
- 假設使用者在求解期間維持網頁連線,若斷線則需重新整理頁面查看結果
- 假設部署環境為單機或小型伺服器,不需考慮負載平衡或高可用性架構

## Constraints

- 必須重用現有的 `simplec.py` 求解器邏輯,不應從頭實作 CFD 演算法
- 視覺化圖表必須支援基本互動功能 (縮放、平移、懸停顯示數值)
- 系統應能在一般桌上型電腦或筆記型電腦的瀏覽器中流暢運作
- 初期版本僅支援蓋驅動方腔流問題,不需支援其他流場幾何或邊界條件

## Out of Scope

- 使用者帳號管理和驗證系統
- 歷史模擬記錄和結果資料庫
- 多使用者並行求解和任務排程
- 其他流場問題類型 (如管流、外部繞流等)
- 三維流場模擬
- 網格生成工具 (僅使用結構化均勻網格)
- 後處理動畫 (如流線動畫、渦度視覺化)
- 行動裝置最佳化 (優先支援桌面瀏覽器)
